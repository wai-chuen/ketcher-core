{"code":"/****************************************************************************\r\n * Copyright 2021 EPAM Systems\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *    http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n ***************************************************************************/\r\nimport { AtomAdd, BondAdd, FragmentAdd, FragmentAddStereoAtom, RGroupFragment, RxnArrowAdd, RxnPlusAdd, SimpleObjectAdd, TextCreate, CalcImplicitH } from '../operations';\r\nimport { fromRGroupAttrs, fromUpdateIfThen } from './rgroup';\r\nimport { Action } from './action';\r\nimport { Vec2 } from \"../../../domain/entities\";\r\nimport { fromSgroupAddition } from './sgroup';\r\nexport function fromPaste(restruct, pstruct, point, angle = 0) {\r\n    const xy0 = getStructCenter(pstruct);\r\n    const offset = Vec2.diff(point, xy0);\r\n    const action = new Action();\r\n    const aidMap = new Map();\r\n    const fridMap = new Map();\r\n    const pasteItems = {\r\n        // only atoms and bonds now\r\n        atoms: [],\r\n        bonds: []\r\n    };\r\n    pstruct.atoms.forEach((atom, aid) => {\r\n        if (!fridMap.has(atom.fragment)) {\r\n            fridMap.set(atom.fragment, action.addOp(new FragmentAdd().perform(restruct)).frid);\r\n        }\r\n        const tmpAtom = Object.assign(atom.clone(), {\r\n            fragment: fridMap.get(atom.fragment)\r\n        });\r\n        const operation = new AtomAdd(tmpAtom, Vec2.diff(atom.pp, xy0).rotate(angle).add(point)).perform(restruct);\r\n        action.addOp(operation);\r\n        aidMap.set(aid, operation.data.aid);\r\n        pasteItems.atoms.push(operation.data.aid);\r\n    });\r\n    pstruct.frags.forEach((frag, frid) => {\r\n        if (!frag)\r\n            return;\r\n        frag.stereoAtoms.forEach((aid) => action.addOp(new FragmentAddStereoAtom(fridMap.get(frid), aidMap.get(aid)).perform(restruct)));\r\n    });\r\n    pstruct.bonds.forEach((bond) => {\r\n        const operation = new BondAdd(aidMap.get(bond.begin), aidMap.get(bond.end), bond).perform(restruct);\r\n        action.addOp(operation);\r\n        pasteItems.bonds.push(operation.data.bid);\r\n    });\r\n    pasteItems.atoms.forEach((aid) => {\r\n        action.addOp(new CalcImplicitH([aid]).perform(restruct));\r\n    });\r\n    pstruct.sgroups.forEach((sg) => {\r\n        const newsgid = restruct.molecule.sgroups.newId();\r\n        const sgAtoms = sg.atoms.map((aid) => aidMap.get(aid));\r\n        const sgAction = fromSgroupAddition(restruct, sg.type, sgAtoms, sg.data, newsgid, sg.pp ? sg.pp.add(offset) : null, sg.type === 'SUP' ? sg.data.expanded : null, sg.data.name);\r\n        sgAction.operations.reverse().forEach((oper) => {\r\n            action.addOp(oper);\r\n        });\r\n    });\r\n    pstruct.rxnArrows.forEach((rxnArrow) => {\r\n        action.addOp(new RxnArrowAdd(rxnArrow.pos.map((p) => p.add(offset)), rxnArrow.mode).perform(restruct));\r\n    });\r\n    pstruct.rxnPluses.forEach((plus) => {\r\n        action.addOp(new RxnPlusAdd(plus.pp.add(offset)).perform(restruct));\r\n    });\r\n    pstruct.simpleObjects.forEach((simpleObject) => {\r\n        action.addOp(new SimpleObjectAdd(simpleObject.pos.map((p) => p.add(offset)), simpleObject.mode).perform(restruct));\r\n    });\r\n    pstruct.texts.forEach((text) => {\r\n        action.addOp(new TextCreate(text.content, text.position.add(offset), text.pos.map((p) => p.add(offset))).perform(restruct));\r\n    });\r\n    pstruct.rgroups.forEach((rg, rgid) => {\r\n        rg.frags.forEach((__frag, frid) => {\r\n            action.addOp(new RGroupFragment(rgid, fridMap.get(frid)).perform(restruct));\r\n        });\r\n        const ifThen = pstruct.rgroups.get(rgid).ifthen;\r\n        const newRgId = pstruct.rgroups.get(ifThen) ? ifThen : 0;\r\n        action\r\n            .mergeWith(fromRGroupAttrs(restruct, rgid, rg.getAttrs()))\r\n            .mergeWith(fromUpdateIfThen(restruct, newRgId, rg.ifthen));\r\n    });\r\n    action.operations.reverse();\r\n    return [action, pasteItems];\r\n}\r\nfunction getStructCenter(struct) {\r\n    // TODO: Review, function may not work sometimes\r\n    const onlyOneStructsSgroupId = struct.sgroups.keys().next().value;\r\n    if (struct.sgroups.size === 1 &&\r\n        !struct.sgroups.get(onlyOneStructsSgroupId).data.expanded) {\r\n        return struct.atoms.get(0).pp;\r\n    }\r\n    if (struct.atoms.size > 0) {\r\n        let xmin = 1e50;\r\n        let ymin = xmin;\r\n        let xmax = -xmin;\r\n        let ymax = -ymin;\r\n        struct.atoms.forEach((atom) => {\r\n            xmin = Math.min(xmin, atom.pp.x);\r\n            ymin = Math.min(ymin, atom.pp.y);\r\n            xmax = Math.max(xmax, atom.pp.x);\r\n            ymax = Math.max(ymax, atom.pp.y);\r\n        });\r\n        return new Vec2((xmin + xmax) / 2, (ymin + ymax) / 2); // TODO: check\r\n    }\r\n    if (struct.rxnArrows.size > 0)\r\n        return struct.rxnArrows.get(0).center();\r\n    if (struct.rxnPluses.size > 0)\r\n        return struct.rxnPluses.get(0).pp;\r\n    if (struct.simpleObjects.size > 0)\r\n        return struct.simpleObjects.get(0).center();\r\n    if (struct.texts.size > 0)\r\n        return struct.texts.get(0).position;\r\n    return null;\r\n}\r\n//# sourceMappingURL=paste.js.map","references":["/usr/local/google/home/waich/workspace/ketcher/packages/ketcher-core/src/application/editor/operations/index.ts","/usr/local/google/home/waich/workspace/ketcher/packages/ketcher-core/src/application/editor/actions/rgroup.ts","/usr/local/google/home/waich/workspace/ketcher/packages/ketcher-core/src/application/editor/actions/action.ts","/usr/local/google/home/waich/workspace/ketcher/packages/ketcher-core/src/domain/entities/index.ts","/usr/local/google/home/waich/workspace/ketcher/packages/ketcher-core/src/application/editor/actions/sgroup.ts"],"map":"{\"version\":3,\"file\":\"paste.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../../../../src/application/editor/actions/paste.ts\"],\"names\":[],\"mappings\":\"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\"}","dts":{"name":"/usr/local/google/home/waich/workspace/ketcher/packages/ketcher-core/node_modules/.cache/rollup-plugin-typescript2/placeholder/application/editor/actions/paste.d.ts","writeByteOrderMark":false,"text":"/****************************************************************************\r\n * Copyright 2021 EPAM Systems\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *    http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n ***************************************************************************/\r\nexport declare function fromPaste(restruct: any, pstruct: any, point: any, angle?: number): any[];\r\n"}}
